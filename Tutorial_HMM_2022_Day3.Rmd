---
title: 'HMM in Marine Sciences: model selection, covariates, hierarchical structures' 
author: "Marco Gallegos Herrada and Vianey Leos Barajas"
output: 
  bookdown::html_document2:
    number_sections: true
    highlight: tango
editor_options:
  chunk_output_type: console
---

<!-- To be able to have continuous line numbers -->
```{=html}
<style>
body
  { counter-reset: source-line 0; }
pre.numberSource code
  { counter-reset: none; }
</style>
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE)
```



```{r,eval=F}
library(readr)
library(momentuHMM)
library(ggplot2)
library(dplyr)
library(lubridate)
```

```{r,echo=F,message=FALSE}

library(lubridate)
library(readr)
library(dplyr)
library(ggplot2)
library(momentuHMM)

```


```{r}

```



```{r,eval=F}
BlacktipB <- read_delim("C:/Users/marco/Downloads/BlacktipB_original.txt", 
                        delim = "\t", escape_double = FALSE, 
                        trim_ws = TRUE)
BlacktipB = BlacktipB %>% 
  mutate(Time = as.POSIXct(Time,format = "%m/%d/%Y %H:%M")) %>% 
  mutate(day = day(Time),hour_to_sec =  as.integer(seconds(hm(format(Time, format = "%H:%M")))))

BlacktipB = BlacktipB %>% group_by(Time) %>% mutate(sec = row_number()) %>% ungroup() %>% 
  mutate(sec = case_when(hour_to_sec == 53160 ~ as.integer(sec + 55),
                         TRUE ~ sec),
         hour_to_sec = hour_to_sec + sec,
         group_10s = case_when(sec <= 10 ~ 1,
                               10 < sec & sec <= 20 ~ 2,
                               20 < sec & sec <= 30 ~ 3,
                               30 < sec & sec <= 40~ 4,
                               40 < sec & sec <= 50 ~ 5,
                               50 < sec & sec <= 60 ~ 6,
                               TRUE ~ -1),
         group_30s = case_when(sec <= 30 ~ 1,
                               30 < sec & sec <= 60 ~ 2,
                               TRUE ~ -1)) %>% 
  group_by(Time,group_10s) %>% mutate(ODBA_mean_10s = mean(ODBA)) %>% ungroup() %>% 
  group_by(Time,group_30s) %>% mutate(ODBA_mean_30s = mean(ODBA)) %>% ungroup() %>% 
  group_by(Time) %>% mutate(ODBA_mean_60s = mean(ODBA)) %>%
  mutate(hour_to_sec_10s = floor((hour_to_sec-1)/10+1),
         hour_to_sec_30s = floor((hour_to_sec-1)/30+1),
         hour_to_sec_60s = floor((hour_to_sec-1)/60+1)) 

```

```{r,echo=F}

BlacktipB = readRDS("BlacktipB_tidy.rds")

head(BlacktipB)

```

```{r}

BlacktipB_10s = BlacktipB %>% group_by(Time,group_10s) %>% filter(row_number() == 1) %>%
  ungroup() %>% select(Time,Depth,ODBA_mean_10s,hour_to_sec_10s)
BlacktipB_30s = BlacktipB %>% group_by(Time,group_30s) %>% filter(row_number() == 1) %>% 
  ungroup() %>% select(Time,Depth,ODBA_mean_30s,hour_to_sec_30s)
BlacktipB_60s = BlacktipB %>% group_by(Time) %>% filter(row_number() == 1) %>% 
  ungroup() %>% select(Time,Depth,ODBA_mean_60s,hour_to_sec_60s)

BlacktipB = BlacktipB %>% select(Time,Depth,ODBA,hour_to_sec)

```

```{r,echo=F}

knitr::include_graphics("plots/timeSeriesODBA.png")

```

As in article, we are going to filter certain values, since these are super messy

```{r}

BlacktipB = BlacktipB %>% filter(ODBA <= 2.0)

```

Much better. thus, we are ready to start to look for models for this data!

```{r,echo=F}

knitr::include_graphics("plots/timeSeriesODBA_constrained.png")

```


```{r}

BlacktipBData = prepData(BlacktipB,coordNames = NULL,
                   covNames = "hour_to_sec")

BlacktipBData_10s = prepData(BlacktipB_10s,coordNames = NULL,
                   covNames = "hour_to_sec_10s")

BlacktipBData_30s = prepData(BlacktipB_30s,coordNames = NULL,
                   covNames = "hour_to_sec_30s")

BlacktipBData_60s = prepData(BlacktipB_60s,coordNames = NULL,
                   covNames = "hour_to_sec_60s")
```

```{r}

hist(BlacktipBData$ODBA,breaks=80)

```

```{r,eval=F}

fit1 = fitHMM(BlacktipBData,nbStates=2,dist=list(ODBA="gamma"),Par0 = list(ODBA=c(.1,.3,1,1)))

fit1
```

```{r}

fit1 = readRDS("BlacktipB_m1.rds")
fit1

```

```{r,eval=F}

fit1_10s = fitHMM(BlacktipBData,nbStates=2,dist=list(ODBA_mean_10s="gamma"),
                  Par0 = list(ODBA_mean_10s=c(.1,.3,1,1)))
fit1_10s

```

```{r}

fit1_10s = readRDS("BlacktipB_m1_10s.rds")
fit1_10s

```



```{r,eval=F}

fit1_30s = fitHMM(BlacktipBData,nbStates=2,dist=list(ODBA_mean_30s="gamma"),
                  Par0 = list(ODBA_mean_30s=c(.1,.3,1,1)))
fit1_30s

```

```{r}

fit1_30s = readRDS("BlacktipB_m1_30s.rds")
fit1_30s

```



```{r,eval=F}
fit1_60s = fitHMM(BlacktipBData,nbStates=2,dist=list(ODBA_mean_60s="gamma"),
                  Par0 = list(ODBA_mean_60s=c(.1,.3,1,1)))
fit1_60s


```

```{r}

fit1_60s = readRDS("BlacktipB_m1_60s.rds")
fit1_60s

```

```{r}

knitr::include_graphics("fit1.jpg")

```

## Incorporating covariates

```{r,eval=F}

formula = ~ cosinor(hour_to_sec, period = 86400)
Par0_fit2 <- getPar0(model=fit1, formula=formula)

fit2 = fitHMM(BlacktipBData,nbStates=2,dist=list(ODBA="gamma"),Par0 = list(ODBA=c(.1,.3,1,1)))

fit2
```

```{r}

fit2 = readRDS("BlacktipB_m2.rds")
fit2

```

```{r,eval=F}

formula_10s = ~ cosinor(hour_to_sec_10s, period = 8640)
Par0_fit2_10s <- getPar0(model=fit1_10s, formula=formula_10s)


fit2_10s = fitHMM(BlacktipBData_10s,nbStates=2,dist=list(ODBA_mean_10s="gamma"),
                  Par0 = list(ODBA_mean_10s=c(.1,.3,1,1)))
fit2_10s

```

```{r}

fit2_10s = readRDS("BlacktipB_m2_10s.rds")
fit2_10s

```



```{r,eval=F}

formula_30s = ~ cosinor(hour_to_sec_30s, period = 2880)
Par0_fit2_30s <- getPar0(model=fit1_30s, formula=formula_30s)

fit2_30s = fitHMM(BlacktipBData_30s,nbStates=2,dist=list(ODBA_mean_30s="gamma"),
                  Par0 = list(ODBA_mean_30s=c(.1,.3,1,1)))
fit2_30s

```

```{r}

fit2_30s = readRDS("BlacktipB_m2_30s.rds")
fit2_30s

```



```{r,eval=F}

formula_60s = ~ cosinor(hour_to_sec_60s, period = 1440)
Par0_fit2_60s <- getPar0(model=fit1_60s, formula=formula_60s)

fit2_60s = fitHMM(BlacktipBData_60s,nbStates=2,dist=list(ODBA_mean_60s="gamma"),
                  Par0 = list(ODBA_mean_60s=c(.1,.3,1,1)))
fit2_60s


```

```{r}

fit2_60s = readRDS("BlacktipB_m2_60s.rds")
fit2_60s

```

```{r}

knitr::include_graphics("fit1.jpg")

```

## Hierarchical Hidden Markov models

```{r}

tigerShark <- read_csv("tigershark_depthchange10min.csv")
head(tigerShark)

```


```{r}

tigerShark %>%
  filter(days != 9) %>% 
  ggplot(aes(x=HST,y=Depth)) + facet_wrap(~days,scales = "free_x") + geom_line() +
  scale_x_datetime(breaks= "8 hour", date_labels = "%H:%M") + theme_minimal()

tigerShark %>% mutate(change_depth = Depth - lag(Depth,default = 0)) %>%
  filter(days != 9) %>% 
  ggplot(aes(x=HST,y=2*abs(change_depth))) + facet_wrap(~days,scales = "free_x") + geom_line() +
  scale_x_datetime(breaks= "8 hour", date_labels = "%H:%M") + theme_minimal()


```
